name: Public Desktop Full Test Build

on:
  repository_dispatch:
    types: [public-desktop-full-test]
  workflow_dispatch:
    inputs:
      ref:
        description: Branch, tag, or SHA to build (optional)
        required: false
        type: string

env:
  APP_DIR: apps/windword-desktop
  PNPM_VERSION: 9
  PNPM_STORE_PATH: ~/.pnpm-store
  NODE_VERSION: 20

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      checkout_ref: ${{ steps.meta.outputs.checkout_ref }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - name: Resolve ref and sha
        id: meta
        env:
          PAYLOAD_SHA: ${{ github.event.client_payload.sha }}
          PAYLOAD_REF: ${{ github.event.client_payload.ref }}
          INPUT_REF: ${{ inputs.ref }}
        run: |
          set -euo pipefail
          ref="${PAYLOAD_SHA:-}"
          if [ -z "$ref" ] && [ -n "${PAYLOAD_REF:-}" ]; then
            ref="$PAYLOAD_REF"
          fi
          if [ -z "$ref" ] && [ -n "${INPUT_REF:-}" ]; then
            ref="$INPUT_REF"
          fi
          if [ -z "$ref" ]; then
            ref="${GITHUB_SHA}"
          fi
          sha="${PAYLOAD_SHA:-${GITHUB_SHA}}"
          short="${sha:0:7}"
          echo "checkout_ref=$ref" >> "$GITHUB_OUTPUT"
          echo "short_sha=$short" >> "$GITHUB_OUTPUT"

  macos-arm64:
    needs: prepare
    runs-on: macos-latest
    permissions:
      contents: read
    env:
      CSC_IDENTITY_AUTO_DISCOVERY: false
      CI: true
      SHORT_SHA: ${{ needs.prepare.outputs.short_sha }}
      INCLUDE_METADATA: 'true'
      ARTIFACT_FILENAME_SUFFIX: ''
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: feiandxs/windword
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable pnpm via corepack
        shell: bash
        run: |
          corepack enable
          corepack prepare pnpm@${PNPM_VERSION} --activate
          pnpm --version

      - name: Install dependencies
        shell: bash
        run: pnpm install --frozen-lockfile --config.store-dir=${PNPM_STORE_PATH}

      - name: Build Apple Speech CLI
        shell: bash
        run: pnpm build:apple-speech-cli

      - name: Build Apple Audio Mute CLI
        shell: bash
        run: pnpm build:apple-audio-mute-cli

      - name: Build Apple Audio Device CLI
        shell: bash
        run: pnpm build:apple-audio-device-cli

      - name: Build Apple Selection Detector CLI
        shell: bash
        run: pnpm build:apple-selection-detector-cli

      - name: Build desktop (mac arm64)
        shell: bash
        run: |
          pnpm --filter @windword/desktop build
          pnpm --filter @windword/desktop exec electron-builder --mac zip --arm64

      - name: Package artifacts
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p release
          APP_DIST="${APP_DIR}/dist"
          zip=$(find "$APP_DIST" -maxdepth 1 -type f -name '*.zip' ! -name '*.blockmap' -print -quit || true)
          if [ -z "$zip" ]; then
            echo 'No zip artifact produced by electron-builder' >&2
            exit 1
          fi
          base_name="$(basename "$zip")"
          if [ -n "${ARTIFACT_FILENAME_SUFFIX}" ]; then
            ext="${base_name##*.}"
            stem="${base_name%.*}"
            base_name="${stem}-${ARTIFACT_FILENAME_SUFFIX}.${ext}"
          fi
          cp "$zip" "release/${base_name}"
          if [ "${INCLUDE_METADATA}" = "true" ]; then
            METADATA_FILE=$(find "$APP_DIST" -maxdepth 1 -type f -name 'latest-mac*.yml' -print -quit || true)
            if [ -z "$METADATA_FILE" ]; then
              echo 'latest-mac.yml metadata was not produced' >&2
              exit 1
            fi
            cp "$METADATA_FILE" "release/$(basename "$METADATA_FILE")"
            find "$APP_DIST" -maxdepth 1 -type f -name '*.blockmap' -exec cp {} release/ \;
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-test
          path: release

  macos-arm64-with-model:
    needs: prepare
    runs-on: macos-latest
    permissions:
      contents: read
    env:
      CSC_IDENTITY_AUTO_DISCOVERY: false
      CI: true
      SHORT_SHA: ${{ needs.prepare.outputs.short_sha }}
      INCLUDE_METADATA: 'false'
      ARTIFACT_FILENAME_SUFFIX: 'with-model'
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: feiandxs/windword
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable pnpm via corepack
        shell: bash
        run: |
          corepack enable
          corepack prepare pnpm@${PNPM_VERSION} --activate
          pnpm --version

      - name: Install dependencies
        shell: bash
        run: pnpm install --frozen-lockfile --config.store-dir=${PNPM_STORE_PATH}

      - name: Build Apple Speech CLI
        shell: bash
        run: pnpm build:apple-speech-cli

      - name: Build Apple Audio Mute CLI
        shell: bash
        run: pnpm build:apple-audio-mute-cli

      - name: Build Apple Audio Device CLI
        shell: bash
        run: pnpm build:apple-audio-device-cli

      - name: Build Apple Selection Detector CLI
        shell: bash
        run: pnpm build:apple-selection-detector-cli

      - name: Prepare SenseVoice model
        shell: bash
        run: pnpm --filter @windword/desktop prepare:sensevoice-model

      - name: Build desktop (mac arm64 with model)
        shell: bash
        run: |
          pnpm --filter @windword/desktop build
          pnpm --filter @windword/desktop exec electron-builder --mac zip --arm64

      - name: Package artifacts
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p release
          APP_DIST="${APP_DIR}/dist"
          zip=$(find "$APP_DIST" -maxdepth 1 -type f -name '*.zip' ! -name '*.blockmap' -print -quit || true)
          if [ -z "$zip" ]; then
            echo 'No zip artifact produced by electron-builder' >&2
            exit 1
          fi
          base_name="$(basename "$zip")"
          if [ -n "${ARTIFACT_FILENAME_SUFFIX}" ]; then
            ext="${base_name##*.}"
            stem="${base_name%.*}"
            base_name="${stem}-${ARTIFACT_FILENAME_SUFFIX}.${ext}"
          fi
          cp "$zip" "release/${base_name}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-with-model-test
          path: release

  linux-x64:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CI: true
      SHORT_SHA: ${{ needs.prepare.outputs.short_sha }}
      INCLUDE_METADATA: 'true'
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: feiandxs/windword
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable pnpm via corepack
        shell: bash
        run: |
          corepack enable
          corepack prepare pnpm@${PNPM_VERSION} --activate
          pnpm --version

      - name: Install dependencies
        shell: bash
        run: pnpm install --frozen-lockfile --config.store-dir=${PNPM_STORE_PATH}

      - name: Build desktop (linux x64)
        shell: bash
        run: |
          pnpm --filter @windword/desktop build
          pnpm --filter @windword/desktop exec electron-builder --linux AppImage --x64

      - name: Package artifacts
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p release
          APP_DIST="${APP_DIR}/dist"
          appimage=$(find "$APP_DIST" -maxdepth 1 -type f -name '*.AppImage' -print -quit || true)
          if [ -z "$appimage" ]; then
            echo 'No AppImage artifact produced by electron-builder' >&2
            exit 1
          fi
          cp "$appimage" "release/$(basename "$appimage")"
          if [ "${INCLUDE_METADATA}" = "true" ]; then
            METADATA_FILE=$(find "$APP_DIST" -maxdepth 1 -type f -name 'latest-linux*.yml' -print -quit || true)
            if [ -z "$METADATA_FILE" ]; then
              echo 'latest-linux.yml metadata was not produced' >&2
              exit 1
            fi
            cp "$METADATA_FILE" "release/$(basename "$METADATA_FILE")"
            find "$APP_DIST" -maxdepth 1 -type f -name '*.AppImage.blockmap' -exec cp {} release/ \;
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-test
          path: release

  windows-x64:
    needs: prepare
    runs-on: windows-latest
    permissions:
      contents: read
    env:
      CI: true
      SHORT_SHA: ${{ needs.prepare.outputs.short_sha }}
      INCLUDE_METADATA: 'true'
      ARTIFACT_FILENAME_SUFFIX: ''
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: feiandxs/windword
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable pnpm via corepack
        shell: bash
        run: |
          corepack enable
          corepack prepare pnpm@${PNPM_VERSION} --activate
          pnpm --version

      - name: Install dependencies
        shell: bash
        run: pnpm install --frozen-lockfile --config.store-dir=${PNPM_STORE_PATH}

      - name: Build desktop (windows x64)
        shell: bash
        run: |
          pnpm --filter @windword/desktop build
          pnpm --filter @windword/desktop exec electron-builder --win nsis --x64

      - name: Package artifacts
        shell: bash
        env:
          USE_SYSTEM_NSIS: 'true'
        run: |
          set -euxo pipefail
          mkdir -p release
          APP_DIST="${APP_DIR}/dist"
          installer=$(find "$APP_DIST" -maxdepth 1 -type f -name '*.exe' -print -quit || true)
          if [ -z "$installer" ]; then
            echo 'No Windows installer produced by electron-builder' >&2
            exit 1
          fi
          base_name="$(basename "$installer")"
          if [ -n "${ARTIFACT_FILENAME_SUFFIX}" ]; then
            ext="${base_name##*.}"
            stem="${base_name%.*}"
            base_name="${stem}-${ARTIFACT_FILENAME_SUFFIX}.${ext}"
          fi
          cp "$installer" "release/${base_name}"
          if [ "${INCLUDE_METADATA}" = "true" ]; then
            METADATA_FILE=$(find "$APP_DIST" -maxdepth 1 -type f -name 'latest.yml' -print -quit || true)
            if [ -z "$METADATA_FILE" ]; then
              echo 'latest.yml metadata was not produced' >&2
              exit 1
            fi
            cp "$METADATA_FILE" "release/$(basename "$METADATA_FILE")"
            find "$APP_DIST" -maxdepth 1 -type f -name '*.blockmap' -exec cp {} release/ \;
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-test
          path: release

  windows-x64-with-model:
    needs: prepare
    runs-on: windows-latest
    permissions:
      contents: read
    env:
      CI: true
      SHORT_SHA: ${{ needs.prepare.outputs.short_sha }}
      INCLUDE_METADATA: 'false'
      ARTIFACT_FILENAME_SUFFIX: 'with-model'
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: feiandxs/windword
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable pnpm via corepack
        shell: bash
        run: |
          corepack enable
          corepack prepare pnpm@${PNPM_VERSION} --activate
          pnpm --version

      - name: Install dependencies
        shell: bash
        run: pnpm install --frozen-lockfile --config.store-dir=${PNPM_STORE_PATH}

      - name: Prepare SenseVoice model
        shell: bash
        run: pnpm --filter @windword/desktop prepare:sensevoice-model

      - name: Build desktop (windows x64 with model)
        shell: bash
        run: |
          pnpm --filter @windword/desktop build
          pnpm --filter @windword/desktop exec electron-builder --win nsis --x64

      - name: Package artifacts
        shell: bash
        env:
          USE_SYSTEM_NSIS: 'true'
        run: |
          set -euxo pipefail
          mkdir -p release
          APP_DIST="${APP_DIR}/dist"
          installer=$(find "$APP_DIST" -maxdepth 1 -type f -name '*.exe' -print -quit || true)
          if [ -z "$installer" ]; then
            echo 'No Windows installer produced by electron-builder' >&2
            exit 1
          fi
          base_name="$(basename "$installer")"
          if [ -n "${ARTIFACT_FILENAME_SUFFIX}" ]; then
            ext="${base_name##*.}"
            stem="${base_name%.*}"
            base_name="${stem}-${ARTIFACT_FILENAME_SUFFIX}.${ext}"
          fi
          cp "$installer" "release/${base_name}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-with-model-test
          path: release
