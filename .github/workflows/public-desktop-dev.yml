name: Public Desktop Dev Build

on:
  repository_dispatch:
    types: [public-desktop-dev]
  workflow_dispatch:
    inputs:
      ref:
        description: Branch, tag, or SHA to build (optional)
        required: false
        type: string
      include_metadata:
        description: Include electron-builder metadata/blockmap
        required: false
        type: boolean
        default: true

jobs:
  prepare:
    uses: ./.github/workflows/public-shared-prepare.yml
    with:
      runner: ubuntu-latest
      target_ref: ${{ github.event.client_payload.ref || inputs.ref || 'refs/heads/develop' }}
      target_sha: ${{ github.event.client_payload.sha || '' }}

  macos-arm64:
    needs: prepare
    uses: ./.github/workflows/public-shared-macos-arm64.yml
    with:
      runner: macos-26
      checkout_ref: ${{ needs.prepare.outputs.checkout_ref }}
      short_sha: ${{ needs.prepare.outputs.short_sha }}
      include_metadata: ${{ inputs.include_metadata }}
      include_sensevoice_model: 'false'
      artifact_name: macos-arm64-dev
      artifact_filename_suffix: ''
    secrets: inherit

  macos-x64:
    needs: prepare
    uses: ./.github/workflows/public-shared-macos-x64.yml
    with:
      runner: macos-26
      checkout_ref: ${{ needs.prepare.outputs.checkout_ref }}
      short_sha: ${{ needs.prepare.outputs.short_sha }}
      include_metadata: ${{ inputs.include_metadata }}
      include_sensevoice_model: 'false'
      artifact_name: macos-x64-dev
      artifact_filename_suffix: ''
    secrets: inherit

  linux-x64:
    needs: prepare
    uses: ./.github/workflows/public-shared-linux-x64.yml
    with:
      runner: ubuntu-latest
      checkout_ref: ${{ needs.prepare.outputs.checkout_ref }}
      short_sha: ${{ needs.prepare.outputs.short_sha }}
      include_metadata: ${{ inputs.include_metadata }}
      artifact_name: linux-x64-dev
      artifact_filename_suffix: ''
      preserve_original_filenames: 'true'
    secrets: inherit

  windows-x64:
    needs: prepare
    uses: ./.github/workflows/public-shared-windows-x64.yml
    with:
      runner: windows-latest
      checkout_ref: ${{ needs.prepare.outputs.checkout_ref }}
      short_sha: ${{ needs.prepare.outputs.short_sha }}
      app_dir: apps/windword-desktop
      artifact_suffix: windows-x64
      electron_builder_args: --win nsis --x64
      node_version: '20'
      pnpm_version: '9'
      pnpm_store_path: ~/.pnpm-store
      include_metadata: ${{ inputs.include_metadata }}
      include_sensevoice_model: 'false'
      artifact_name: windows-x64-dev
      artifact_filename_suffix: ''
      preserve_original_filenames: 'true'
    secrets: inherit
